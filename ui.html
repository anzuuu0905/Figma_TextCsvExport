
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>Figma Text Extractor</title>
</head>
<body>
  <button onclick="sendToSheet()">スプレッドシートに送信</button>
  <div id="status"></div>

  <script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxMdPpFqSPrFBDPubJHKMOCxP_u0CVCMx2EVGY5s_vw83FWWgqg6TSgnYnkltU6Mjgv/exec';
      let extractedData = [];

    onmessage = (event) => {
      if (event.data.pluginMessage.type === 'send-text-data') {
        extractedData = event.data.pluginMessage.data;
        console.log('データを受信:', extractedData.length + '件');
      }
    };

    async function sendToSheet() {
      updateStatus('送信中...');

      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'no-cors',  // これを追加
          headers: {
            'Content-Type': 'text/plain;charset=utf-8',
          },
          body: JSON.stringify({
            spreadsheetId: "12SiOW1il5v95quDUM4xU_h12fJvI6fuXs9KmMhTA084",
            sheetName: "シート1",
            data: extractedData
          })
        });

        // no-corsモードではresponse.okが使えないので、
        // エラーが発生しなければ成功とみなす
        onSuccess(extractedData.length);

      } catch (error) {
        onError(error);
      }
    }

    function onSuccess(totalRows) {
      const message = `成功: 全${totalRows}件のデータを送信しました`;
      updateStatus(message);
      parent.postMessage({ pluginMessage: {
        type: 'complete',
        message: message
      }}, '*');
    }

    function onError(error) {
      const errorMessage = `送信エラー: ${error.message || error}`;
      updateStatus(errorMessage);
      parent.postMessage({ pluginMessage: {
        type: 'error',
        message: errorMessage
      }}, '*');
    }

    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }
  </script>
</body>
</html>

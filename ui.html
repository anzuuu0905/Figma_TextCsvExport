<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>Text Import/Export</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
      margin: 0;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 8px;
      background-color: #18A0FB;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button + button{
      margin-top: 10px;
    }
    #status {
      margin-top: 10px;
      padding: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="form-group">
    <label for="spreadsheetUrl">スプレッドシートURL:</label>
    <input type="text"
           id="spreadsheetUrl"
           placeholder="https://docs.google.com/spreadsheets/d/..."
           required>
  </div>

  <div class="form-group">
    <label for="sheetName">シート名:</label>
    <input type="text"
           id="sheetName"
           placeholder="シート1"
           value="シート1"
           required>
  </div>

  <div class="button-group">
    <button onclick="sendToSheet()">エクスポート</button>
    <button onclick="importFromSheet()">インポート</button>
  </div>
  <div id="status"></div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxMdPpFqSPrFBDPubJHKMOCxP_u0CVCMx2EVGY5s_vw83FWWgqg6TSgnYnkltU6Mjgv/exec';
    let extractedData = [];

    onmessage = (event) => {
      if (event.data.pluginMessage.type === 'send-text-data') {
        extractedData = event.data.pluginMessage.data;
        console.log('データを受信:', extractedData.length + '件');
      }
    };

    function extractSpreadsheetId(url) {
      try {
        const trimmedUrl = url.trim();
        const pattern = /\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
        const match = trimmedUrl.match(pattern);

        if (match && match[1]) {
          return match[1];
        }
        throw new Error('有効なスプレッドシートURLを入力してください');
      } catch (error) {
        throw new Error('URLの解析に失敗しました');
      }
    }

    async function sendToSheet() {
      const spreadsheetUrl = document.getElementById('spreadsheetUrl').value;
      const sheetName = document.getElementById('sheetName').value;

      if (!spreadsheetUrl || !sheetName) {
        updateStatus('スプレッドシートURLとシート名を入力してください');
        return;
      }

      updateStatus('送信中...');

      try {
        const spreadsheetId = extractSpreadsheetId(spreadsheetUrl);

        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8',
          },
          body: JSON.stringify({
            spreadsheetId: spreadsheetId,
            sheetName: sheetName,
            data: extractedData
          })
        });

        onSuccess(extractedData.length);
      } catch (error) {
        onError(error);
      }
    }

    function onSuccess(totalRows) {
      const message = `成功: 全${totalRows - 1}件のデータを送信しました`;
      updateStatus(message);
      parent.postMessage({ pluginMessage: {
        type: 'complete',
        message: message
      }}, '*');
    }

    function onError(error) {
      const errorMessage = `送信エラー: ${error.message || error}`;
      updateStatus(errorMessage);
      parent.postMessage({ pluginMessage: {
        type: 'error',
        message: errorMessage
      }}, '*');
    }

    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }

    async function importFromSheet() {
      const spreadsheetUrl = document.getElementById('spreadsheetUrl').value;
      const sheetName = document.getElementById('sheetName').value;

      if (!spreadsheetUrl || !sheetName) {
        updateStatus('スプレッドシートURLとシート名を入力してください');
        return;
      }

      updateStatus('データを取得中...');

      try {
        const spreadsheetId = extractSpreadsheetId(spreadsheetUrl);
        const gasUrl = `${GAS_URL}?spreadsheetId=${spreadsheetId}&sheetName=${sheetName}`;

        const response = await fetch(gasUrl);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error);
        }

        // Figmaプラグインにデータを送信
        parent.postMessage({
          pluginMessage: {
            type: 'import-data',
            data: result.data
          }
        }, '*');

        updateStatus('データを取得しました');
      } catch (error) {
        updateStatus('エラー: ' + error.message);
      }
    }

    // 既存のonmessageハンドラーを拡張
    onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (msg.type === 'send-text-data') {
        extractedData = msg.data;
        console.log('データを受信:', extractedData.length + '件');
      } else if (msg.type === 'import-complete') {
        updateStatus(`${msg.count}件のテキストを更新しました`);
      } else if (msg.type === 'import-error') {
        updateStatus('インポートエラー: ' + msg.message);
      }
    };
  </script>
</body>
</html>
